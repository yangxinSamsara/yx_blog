<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>为什么 Vue 中不要用 index 作为 key？（diff 算法详解） | 杨欣的前端杂记</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/yx_blog/imgs/logo.jpg">
    <meta name="description" content="欢迎来到杨欣的前端杂记">
    
    <link rel="preload" href="/yx_blog/assets/css/0.styles.9025f1a7.css" as="style"><link rel="preload" href="/yx_blog/assets/js/app.e0a8f1e5.js" as="script"><link rel="preload" href="/yx_blog/assets/js/2.95e582b3.js" as="script"><link rel="preload" href="/yx_blog/assets/js/31.2fbe73e3.js" as="script"><link rel="prefetch" href="/yx_blog/assets/js/10.852a3690.js"><link rel="prefetch" href="/yx_blog/assets/js/11.b7d25596.js"><link rel="prefetch" href="/yx_blog/assets/js/12.82266757.js"><link rel="prefetch" href="/yx_blog/assets/js/13.cf1e77f3.js"><link rel="prefetch" href="/yx_blog/assets/js/14.a9e47a7f.js"><link rel="prefetch" href="/yx_blog/assets/js/15.1384f59f.js"><link rel="prefetch" href="/yx_blog/assets/js/16.d5b91b94.js"><link rel="prefetch" href="/yx_blog/assets/js/17.6cab991f.js"><link rel="prefetch" href="/yx_blog/assets/js/18.00aec882.js"><link rel="prefetch" href="/yx_blog/assets/js/19.34034c9c.js"><link rel="prefetch" href="/yx_blog/assets/js/20.8841c49e.js"><link rel="prefetch" href="/yx_blog/assets/js/21.aca8d043.js"><link rel="prefetch" href="/yx_blog/assets/js/22.c40a0d9c.js"><link rel="prefetch" href="/yx_blog/assets/js/23.b24afd47.js"><link rel="prefetch" href="/yx_blog/assets/js/24.be84b6e7.js"><link rel="prefetch" href="/yx_blog/assets/js/25.77357fc0.js"><link rel="prefetch" href="/yx_blog/assets/js/26.8a3d42fc.js"><link rel="prefetch" href="/yx_blog/assets/js/27.70f0fe8a.js"><link rel="prefetch" href="/yx_blog/assets/js/28.c5cf210b.js"><link rel="prefetch" href="/yx_blog/assets/js/29.5ca16a60.js"><link rel="prefetch" href="/yx_blog/assets/js/3.5b12ee6f.js"><link rel="prefetch" href="/yx_blog/assets/js/30.fb1f60c1.js"><link rel="prefetch" href="/yx_blog/assets/js/32.b4d61232.js"><link rel="prefetch" href="/yx_blog/assets/js/33.c87924c5.js"><link rel="prefetch" href="/yx_blog/assets/js/34.70dcd269.js"><link rel="prefetch" href="/yx_blog/assets/js/35.633fb91f.js"><link rel="prefetch" href="/yx_blog/assets/js/4.02bdbb3c.js"><link rel="prefetch" href="/yx_blog/assets/js/5.ce292cd4.js"><link rel="prefetch" href="/yx_blog/assets/js/6.5a41d7cc.js"><link rel="prefetch" href="/yx_blog/assets/js/7.0694149e.js"><link rel="prefetch" href="/yx_blog/assets/js/8.ba0d71a7.js"><link rel="prefetch" href="/yx_blog/assets/js/9.f0236701.js">
    <link rel="stylesheet" href="/yx_blog/assets/css/0.styles.9025f1a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/yx_blog/" class="home-link router-link-active"><img src="/yx_blog/imgs/logo.jpg" alt="杨欣的前端杂记" class="logo"> <span class="site-name can-hide">杨欣的前端杂记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/yx_blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/yx_blog/vue/" class="nav-link">
  vue及周边
</a></div><div class="nav-item"><a href="/yx_blog/about/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="好友链接" class="dropdown-title"><span class="title">好友链接</span> <span class="arrow down"></span></button> <button type="button" aria-label="好友链接" class="mobile-dropdown-title"><span class="title">好友链接</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://zhuijing.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  曹泽鹏的笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shikkk.github.io/file/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  石志凯的技术杂货铺
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://zhangjy1994.github.io/webnotes/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  张佳宇的笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/yx_blog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/yx_blog/vue/" class="nav-link">
  vue及周边
</a></div><div class="nav-item"><a href="/yx_blog/about/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="好友链接" class="dropdown-title"><span class="title">好友链接</span> <span class="arrow down"></span></button> <button type="button" aria-label="好友链接" class="mobile-dropdown-title"><span class="title">好友链接</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://zhuijing.github.io/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  曹泽鹏的笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://shikkk.github.io/file/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  石志凯的技术杂货铺
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://zhangjy1994.github.io/webnotes/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  张佳宇的笔记
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/yx_blog/interview/" class="sidebar-heading clickable"><span>前言</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/yx_blog/interview.html" class="sidebar-link">创建博客目的</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Interview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Html</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yx_blog/views/vue/base.html" class="sidebar-link">vue2.x</a></li><li><a href="/yx_blog/views/vue/vuex.html" class="sidebar-link">Vuex</a></li><li><a href="/yx_blog/views/vue/optimazition.html" class="sidebar-link">vue项目优化</a></li><li><a href="/yx_blog/views/vue/performance-optimize.html" class="sidebar-link">性能优化</a></li><li><a href="/yx_blog/views/vue/vue3.html" class="sidebar-link">Vue3</a></li><li><a href="/yx_blog/views/vue/vuekey.html" aria-current="page" class="active sidebar-link">为什么 Vue 中不要用 index 作为 key？（diff 算法详解）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/yx_blog/views/vue/vuekey.html#示例" class="sidebar-link">示例</a></li><li class="sidebar-sub-header"><a href="/yx_blog/views/vue/vuekey.html#_1-不是相同节点" class="sidebar-link">1. 不是相同节点：</a></li><li class="sidebar-sub-header"><a href="/yx_blog/views/vue/vuekey.html#_2-是相同节点-要尽可能的做节点的复用-都是-ul-进入👈-。" class="sidebar-link">2. 是相同节点，要尽可能的做节点的复用（都是 ul，进入👈）。</a></li><li class="sidebar-sub-header"><a href="/yx_blog/views/vue/vuekey.html#为什么不要以index作为key" class="sidebar-link">为什么不要以index作为key？</a></li><li class="sidebar-sub-header"><a href="/yx_blog/views/vue/vuekey.html#为什么不要用随机数作为key" class="sidebar-link">为什么不要用随机数作为key？</a></li><li class="sidebar-sub-header"><a href="/yx_blog/views/vue/vuekey.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/yx_blog/views/vue/vuekey.html#反驳标题之前-请先看这段" class="sidebar-link">反驳标题之前，请先看这段</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器&amp;Http</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="为什么-vue-中不要用-index-作为-key-diff-算法详解"><a href="#为什么-vue-中不要用-index-作为-key-diff-算法详解" class="header-anchor">#</a> 为什么 Vue 中不要用 index 作为 key？（diff 算法详解）</h1> <p>掘金：https://juejin.cn/post/6844904113587634184</p> <h2 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h2> <p>以这样一个列表为例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
复制代码
</code></pre></div><p>那么它的 <code>vnode</code> 也就是虚拟 dom 节点大概是这样的。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>假设更新以后，我们把子节点的顺序调换了一下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'ul'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
<span class="token operator">+</span>   <span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'2'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">+</span>   <span class="token punctuation">{</span> <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">'li'</span><span class="token punctuation">,</span> <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token literal-property property">vnode</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'1'</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>很显然，这里的 <code>children</code> 部分是我们本文 <code>diff</code> 算法要讲的重点（敲黑板）。</p> <p>首先响应式数据更新后，触发了 <code>渲染 Watcher</code>  的回调函数 <code>vm._update(vm._render())</code>去驱动视图更新，</p> <p><code>vm._render()</code> 其实生成的就是 <code>vnode</code>，而 <code>vm._update</code> 就会带着新的 <code>vnode</code> 去走触发 <code>__patch__</code> 过程。</p> <p>我们直接进入 <code>ul</code> 这个 <code>vnode</code> 的 <code>patch</code> 过程。</p> <p>对比新旧节点是否是相同类型的节点：</p> <h2 id="_1-不是相同节点"><a href="#_1-不是相同节点" class="header-anchor">#</a> 1. 不是相同节点：</h2> <p><code>isSameNode</code>为false的话，直接销毁旧的 <code>vnode</code>，渲染新的 <code>vnode</code>。这也解释了为什么 <code>diff</code> 是同层对比。</p> <h2 id="_2-是相同节点-要尽可能的做节点的复用-都是-ul-进入👈-。"><a href="#_2-是相同节点-要尽可能的做节点的复用-都是-ul-进入👈-。" class="header-anchor">#</a> 2. 是相同节点，要尽可能的做节点的复用（都是 <code>ul</code>，进入👈）。</h2> <p>会调用<code>src/core/vdom/patch.js</code>下的<code>patchVNode</code>方法。</p> <h3 id="如果新-vnode-是文字-vnode"><a href="#如果新-vnode-是文字-vnode" class="header-anchor">#</a> 如果新 vnode 是文字 vnode</h3> <p>就直接调用浏览器的 <code>dom api</code> 把节点的直接替换掉文字内容就好。</p> <h3 id="如果新-vnode-不是文字-vnode"><a href="#如果新-vnode-不是文字-vnode" class="header-anchor">#</a> 如果新 vnode 不是文字 vnode</h3> <p>那么就要开始对子节点 <code>children</code> 进行对比了。（可以类比 <code>ul</code> 中的 <code>li</code> 子元素）。</p> <h4 id="如果有新-children-而没有旧-children"><a href="#如果有新-children-而没有旧-children" class="header-anchor">#</a> 如果有新 children 而没有旧 children</h4> <p>说明是新增 children，直接 <code>addVnodes</code> 添加新子节点。</p> <h4 id="如果有旧-children-而没有新-children"><a href="#如果有旧-children-而没有新-children" class="header-anchor">#</a> 如果有旧 children 而没有新 children</h4> <p>说明是删除 children，直接 <code>removeVnodes</code> 删除旧子节点</p> <h4 id="如果新旧-children-都存在-都存在-li-子节点列表-进入👈"><a href="#如果新旧-children-都存在-都存在-li-子节点列表-进入👈" class="header-anchor">#</a> 如果新旧 children 都存在（都存在 <code>li 子节点列表</code>，进入👈）</h4> <p>那么就是我们 <code>diff算法</code> 想要考察的最核心的点了，也就是新旧节点的 <code>diff</code> 过程。</p> <p>可以打开源码仓库里大致看下这个函数，接下来我会逐步讲解。</p> <p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue%2Fblob%2Fbd6cea0973247e2a8e1d4a2250614c0bf44f0b26%2Fsrc%2Fcore%2Fvdom%2Fpatch.js%23L404-L474" target="_blank" rel="noopener noreferrer">updateChildren<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>通过</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// 旧首节点</span>
  <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token comment">// 新首节点</span>
  <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token comment">// 旧尾节点</span>
  <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token comment">// 新尾节点</span>
  <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
复制代码
</code></pre></div><p>这些变量分别指向<code>旧节点的首尾</code>、<code>新节点的首尾</code>。</p> <p>根据这些指针，在一个 <code>while</code> 循环中不停的对新旧节点的两端的进行对比，然后把两端的指针向不断内部收缩，直到没有节点可以对比。</p> <p>在讲对比过程之前，要讲一个比较重要的函数：<code>sameVnode</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sameVnode</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span>
        a<span class="token punctuation">.</span>tag <span class="token operator">===</span> b<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span>
        a<span class="token punctuation">.</span>isComment <span class="token operator">===</span> b<span class="token punctuation">.</span>isComment <span class="token operator">&amp;&amp;</span>
        <span class="token function">isDef</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">isDef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">sameInputType</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
复制代码
</code></pre></div><p>它是用来判断节点是否可用的关键函数，可以看到，判断是否是 <code>sameVnode</code>，传递给节点的 <code>key</code> 是关键。</p> <p>然后我们接着进入 <code>diff</code> 过程，每一轮都是同样的对比，其中某一项命中了，就递归的进入 <code>patchVnode</code> 针对单个 <code>vnode</code> 进行的过程（如果这个 <code>vnode</code> 又有 <code>children</code>，那么还会来到这个 <code>diff children</code> 的过程 ）：</p> <ol><li>旧首节点和新首节点用 <code>sameNode</code> 对比。</li> <li>旧尾节点和新尾节点用 <code>sameNode</code> 对比</li> <li>旧首节点和新尾节点用 <code>sameNode</code> 对比</li> <li>旧尾节点和新首节点用 <code>sameNode</code> 对比</li> <li>如果以上逻辑都匹配不到，再把所有旧子节点的 <code>key</code> 做一个映射到旧节点下标的 <code>key -&gt; index</code> 表，然后用新 <code>vnode</code> 的 <code>key</code> 去找出在旧节点中可以复用的位置。</li></ol> <p>然后不停的把匹配到的指针向内部收缩，直到新旧节点有一端的指针相遇（说明这个端的节点都被patch过了）。</p> <p>在指针相遇以后，还有两种比较特殊的情况：</p> <ol><li>有新节点需要加入。 如果更新完以后，<code>oldStartIdx &gt; oldEndIdx</code>，说明旧节点都被 <code>patch</code> 完了，但是有可能还有新的节点没有被处理到。接着会去判断是否要新增子节点。</li> <li>有旧节点需要删除。 如果新节点先patch完了，那么此时会走 <code>newStartIdx &gt; newEndIdx</code>  的逻辑，那么就会去删除多余的旧子节点。</li></ol> <h2 id="为什么不要以index作为key"><a href="#为什么不要以index作为key" class="header-anchor">#</a> 为什么不要以index作为key？</h2> <h3 id="节点reverse场景"><a href="#节点reverse场景" class="header-anchor">#</a> 节点reverse场景</h3> <p>假设我们有这样的一段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>item
          <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">&quot;index&quot;</span>
          v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;(num, index) in nums&quot;</span>
          <span class="token operator">:</span>num<span class="token operator">=</span><span class="token string">&quot;num&quot;</span>
          <span class="token operator">:</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;`item${num}`&quot;</span>
        <span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>item<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">&quot;change&quot;</span><span class="token operator">&gt;</span>改变<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;./vue.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
      <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&quot;#app&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">nums</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>nums<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">item</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;num&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                    &lt;div&gt;
                       {{num}}
                    &lt;/div&gt;
                </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;child&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
复制代码
</code></pre></div><p>其实是一个很简单的列表组件，渲染出来 <code>1 2 3</code> 三个数字。我们先以 <code>index</code> 作为key，来跟踪一下它的更新。</p> <p>我们接下来只关注 <code>item</code> 列表节点的更新，在首次渲染的时候，我们的虚拟节点列表 <code>oldChildren</code> 粗略表示是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
复制代码
</code></pre></div><p>在我们点击按钮的时候，会对数组做 <code>reverse</code> 的操作。那么我们此时生成的 <code>newChildren</code> 列表是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     num<span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     num<span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     num<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
复制代码
</code></pre></div><p>发现什么问题没有？key的顺序没变，传入的值完全变了。这会导致一个什么问题？</p> <p>本来按照最合理的逻辑来说，<code>旧的第一个vnode</code> 是应该直接完全复用 <code>新的第三个vnode</code>的，因为它们本来就应该是同一个vnode，自然所有的属性都是相同的。</p> <p>但是在进行子节点的 <code>diff</code> 过程中，会在 <code>旧首节点和新首节点用</code>sameNode<code>对比。</code> 这一步命中逻辑，因为现在<code>新旧两次首部节点</code> 的 <code>key</code> 都是 <code>0</code>了，</p> <p>然后把旧的节点中的第一个 <code>vnode</code> 和 新的节点中的第一个 <code>vnode</code> 进行 <code>patchVnode</code> 操作。</p> <p>这会发生什么呢？我可以大致给你列一下： 首先，正如我之前的文章<a href="https://juejin.im/post/6844904113432444942#heading-8" target="_blank" rel="noopener noreferrer">props的更新如何触发重渲染？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>里所说，在进行 <code>patchVnode</code> 的时候，会去检查 <code>props</code> 有没有变更，如果有的话，会通过 <code>_props.num = 3</code> 这样的逻辑去更新这个响应式的值，触发 <code>dep.notify</code>，触发子组件视图的重新渲染等一套很重的逻辑。</p> <p>然后，还会额外的触发以下几个钩子，假设我们的组件上定义了一些dom的属性或者类名、样式、指令，那么都会被全量的更新。</p> <ol><li>updateAttrs</li> <li>updateClass</li> <li>updateDOMListeners</li> <li>updateDOMProps</li> <li>updateStyle</li> <li>updateDirectives</li></ol> <p>而这些所有重量级的操作（虚拟dom发明的其中一个目的不就是为了减少真实dom的操作么？），都可以通过直接复用 <code>第三个vnode</code> 来避免，是因为我们偷懒写了 <code>index</code> 作为 <code>key</code>，而导致所有的优化失效了。</p> <h3 id="节点删除场景"><a href="#节点删除场景" class="header-anchor">#</a> 节点删除场景</h3> <p>另外，除了会导致性能损耗以外，在<code>删除子节点</code>的场景下还会造成更严重的错误，</p> <p>可以看<a href="https://juejin.im/user/1714893868499086" target="_blank" rel="noopener noreferrer">sea_ljf<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>同学提供的这个<a href="https://link.juejin.cn/?target=https%3A%2F%2Fcodesandbox.io%2Fs%2Fancient-moon-427u7" target="_blank" rel="noopener noreferrer">demo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>假设我们有这样的一段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;(value, index) in arr&quot;</span> <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">&quot;index&quot;</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>test <span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">&quot;handleDelete&quot;</span><span class="token operator">&gt;</span><span class="token keyword">delete</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
  <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;App&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">arr</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">handleDelete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">&quot;&lt;li&gt;{{Math.random()}}&lt;/li&gt;&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
复制代码
</code></pre></div><p>那么一开始的 <code>vnode列表</code>是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">// 这里其实子组件对应的是第一个 假设子组件的text是1</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token comment">// 这里其实子组件对应的是第二个 假设子组件的text是2</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token comment">// 这里其实子组件对应的是第三个 假设子组件的text是3</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
复制代码
</code></pre></div><p>有一个细节需要注意，正如我上一篇文章中所提到的<a href="https://juejin.im/post/6844904113432444942#heading-7" target="_blank" rel="noopener noreferrer">为什么说 Vue 的响应式更新比 React 快？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，Vue 对于组件的 <code>diff</code> 是不关心子组件内部实现的，它只会看你在模板上声明的传递给子组件的一些属性是否有更新。</p> <p>也就是和v-for平级的那部分，回顾一下判断 <code>sameNode</code> 的时候，只会判断<code>key</code>、 <code>tag</code>、<code>是否有data的存在（不关心内部具体的值）</code>、<code>是否是注释节点</code>、<code>是否是相同的input type</code>，来判断是否可以复用这个节点。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>li v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;(value, index) in arr&quot;</span> <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">&quot;index&quot;</span><span class="token operator">&gt;</span> <span class="token comment">// 这里声明的属性</span>
  <span class="token operator">&lt;</span>test <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
复制代码
</code></pre></div><p>有了这些前置知识以后，我们来看看，点击删除子元素后，<code>vnode 列表</code> 变成什么样了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token comment">// 第一个被删了</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">// 这里其实上一轮子组件对应的是第二个 假设子组件的text是2</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;li&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token comment">// 这里其实子组件对应的是第三个 假设子组件的text是3</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
复制代码
</code></pre></div><p>虽然在注释里我们自己清楚的知道，第一个 <code>vnode</code> 被删除了，但是对于 Vue 来说，它是感知不到子组件里面到底是什么样的实现（它不会深入子组件去对比文本内容），那么这时候 Vue 会怎么 <code>patch</code> 呢？</p> <p>由于对应的 <code>key</code>使用了 <code>index</code>导致的错乱，它会把</p> <ol><li><code>原来的第一个节点text: 1</code>直接复用。</li> <li><code>原来的第二个节点text: 2</code>直接复用。</li> <li>然后发现新节点里少了一个，直接把多出来的第三个节点<code>text: 3</code> 丢掉。</li></ol> <p>至此为止，我们本应该把 <code>text: 1</code>节点删掉，然后<code>text: 2</code>、<code>text: 3</code> 节点复用，就变成了错误的把 <code>text: 3</code> 节点给删掉了。</p> <h2 id="为什么不要用随机数作为key"><a href="#为什么不要用随机数作为key" class="header-anchor">#</a> 为什么不要用随机数作为key？</h2> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>item</span>
  <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>Math.random()<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(num, index) in nums<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:num</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>`item${num}`<span class="token punctuation">&quot;</span></span>
<span class="token punctuation">/&gt;</span></span>
复制代码
</code></pre></div><p>其实我听过一种说法，既然官方要求一个 <code>唯一的key</code>，是不是可以用 <code>Math.random()</code> 作为 <code>key</code> 来偷懒？这是一个很鸡贼的想法，看看会发生什么吧。</p> <p>首先 <code>oldVnode</code> 是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">0.6330715699108844</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">0.25104533240710514</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">0.4114769152411637</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">num</span><span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
复制代码
</code></pre></div><p>更新以后是：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
<span class="token operator">+</span>   key<span class="token operator">:</span> <span class="token number">0.11046018699748683</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     num<span class="token operator">:</span> <span class="token number">3</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
<span class="token operator">+</span>   key<span class="token operator">:</span> <span class="token number">0.8549799545696619</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     num<span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">tag</span><span class="token operator">:</span> <span class="token string">&quot;item&quot;</span><span class="token punctuation">,</span>
<span class="token operator">+</span>   key<span class="token operator">:</span> <span class="token number">0.18674467938937478</span><span class="token punctuation">,</span>
    <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>     num<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

复制代码
</code></pre></div><p>可以看到，<code>key</code> 变成了完全全新的 3 个随机数。</p> <p>上面说到，<code>diff</code> 子节点的首尾对比如果都没有命中，就会进入 <code>key</code> 的详细对比过程，简单来说，就是利用旧节点的 <code>key -&gt; index</code> 的关系建立一个 <code>map</code> 映射表，然后用新节点的 <code>key</code> 去匹配，如果没找到的话，就会调用 <code>createElm</code> 方法 <strong>重新建立</strong> 一个新节点。</p> <p>具体代码在这：</p> <div class="language- extra-class"><pre class="language-text"><code>// 建立旧节点的 key -&gt; index 映射表
oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx);

// 去映射表里找可以复用的 index
idxInOld = findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx);
// 一定是找不到的，因为新节点的 key 是随机生成的。
if (isUndef(idxInOld)) {
  // 完全通过 vnode 新建一个真实的子节点
  createElm();
}
复制代码
</code></pre></div><p>也就是说，咱们的这个更新过程可以这样描述： <code>123</code> -&gt; 前面重新创建三个子组件 -&gt; <code>321123</code>  -&gt; 删除、销毁后面三个子组件 -&gt; <code>321</code>。</p> <p>发现问题了吧？这是毁灭性的灾难，创建新的组件和销毁组件的成本你们晓得的伐……本来仅仅是对组件移动位置就可以完成的更新，被我们毁成这样了。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>经过这样的一段旅行，<code>diff</code> 这个庞大的过程就结束了。</p> <p>我们收获了什么？</p> <ol><li>用组件唯一的 <code>id</code>（一般由后端返回）作为它的 <code>key</code>，实在没有的情况下，可以在获取到列表的时候通过某种规则为它们创建一个 <code>key</code>，并保证这个 <code>key</code> 在组件整个生命周期中都保持稳定。</li> <li>如果你的列表顺序会改变，别用 <code>index</code> 作为 <code>key</code>，和没写基本上没区别，因为不管你数组的顺序怎么颠倒，index 都是 <code>0, 1, 2</code> 这样排列，导致 Vue 会复用错误的旧子节点，做很多额外的工作。列表顺序不变也尽量别用，可能会误导新人。</li> <li>千万别用随机数作为 <code>key</code>，不然旧节点会被全部删掉，新节点重新创建，你的老板会被你气死。</li></ol> <h2 id="反驳标题之前-请先看这段"><a href="#反驳标题之前-请先看这段" class="header-anchor">#</a> 反驳标题之前，请先看这段</h2> <p>这篇文章发布以后，很多小伙伴提出了自己的建议和优化。但是也有很多人在评论区说，既然 <code>index</code> 只是在某些特定的场景下会出问题，那 <code>列表顺序保持不变</code> 的情况下还是可以接着用。这样做有什么问题呢？</p> <ol><li>团队代码规范，假设这样一个场景吧，你这边代码里全部写的 <code>:key=&quot;index&quot;</code>，有一个新人入职了跟着写，结果他的场景是删除和乱序的，这种情况你一个个讲原理指正？这就是统一代码规范和最佳实践的作用啊。<code>eslint</code> 甚至也专门有一个 <code>rule</code> 叫做 <code>react/no-array-index-key</code>，为什么要有这些约束和规范？如果社区总结了最佳实践，为什么一定要去打破它？这都是值得思考的。 就像 <code>==</code> 操作符，为什么要禁止？就是因为隐式转换会出很多问题，你说你熟背隐式转换所有原理，你能保证团队所有小伙伴都熟背？何苦有更简单的 <code>===</code> 操作符可以用。</li> <li>说开发效率的问题，<code>index</code> 作为 <code>key</code> 我在上面已经提到了好几种会出问题的情况了，还是坚持要用，就因为简单。那么 <code>TypeScript</code> 也没有火起来的必要吗？它需要多写很多代码，“效率” 很低，为什么它火了？不是因为用 <code>JavaScript</code> 就一定会出现类型错误，而是因为用了 <code>TypeScript</code> 可以更好的保证你代码的稳定性。正如用了 <code>id</code> 作为key，可以比 <code>index</code> 更好的保证稳定性，更何况用 <code>id</code> 也不费事啊。完全都不像 <code>TypeScript</code> 带来的额外的语法成本。</li> <li>所谓的列表顺序稳定，这个稳定你真的能保证吗？除了你前端写死的永远不变的一个列表，就假设你的列表没有在头部<code>新增一项</code>（导致节点全部依次错误复用），在任意位置 <code>删除一项</code>（有时导致错误删除）等这些会导致 <code>patch</code> 过程出现问题的操作。 就举个很简单的例子，你的“静态”列表的顺序是<code>[1, 2, 3]</code>，数据库里突然加入了一条新数据<code>0</code>，那么你认为的不会变的列表的就变成了<code>[0, 1, 2, 3]</code>。然后，<code>1</code> 节点就错误的和 <code>0</code>节点进行 <code>patchVnode</code>， <code>2</code> 节点就错误的和 <code>1</code> 节点进行 <code>patch</code>、导致原本只需要把新增的<code>0</code>节点插入到头部，然后分别对 <code>1 -&gt; 1</code>、<code>2 -&gt; 2</code>、<code>3 -&gt; 3</code> 进行 <code>patchVnode</code>即可（基本没有变化），变成了毁灭的<code>全量更新</code>。（如果子组件是个很重的组件呢？它的每一项都会经历完整的 <code>vm._update(vm._render())</code>）过程，因为 <code>props</code> 变了。</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新时间：:</span> <span class="time">8/3/2021, 6:05:55 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/yx_blog/views/vue/vue3.html" class="prev">
        Vue3
      </a></span> <span class="next"><a href="/yx_blog/views/react/base.html">
        Html
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/yx_blog/assets/js/app.e0a8f1e5.js" defer></script><script src="/yx_blog/assets/js/2.95e582b3.js" defer></script><script src="/yx_blog/assets/js/31.2fbe73e3.js" defer></script>
  </body>
</html>
